
STEMDL classification benchmark
-------------------------------

The STEMDL classification benchmark represents a machine learning model which can classify CBED patterns obtained from crystals into one of the 230 crystallographic space groups. The bencghmark is written in Pytorch Lightning and enables distributed learning on multiple GPUs. The source code is a single Python program "stemdl_classification.py" which reads the configuration file "stemdlConfig.yaml" containing the values of parameters. The sequence of steps performed by the benchmark can be described as follows:
1. read the configuration file ("stemdlConfig.yaml")
2. read the datasets from the training, validation, testing and inference directories as specified in "stemdlConfig.yaml"
3. train the model
4. test the model
4. perform inferencing
5. measure the time of trainig per epoch and time of a single inference operation
6. save the time measurements in "log_file" (see stemdlConfig.yaml)
7. save MLCOmmons logging in "mlperf_logfile" (see stemdlConfig.yaml)

Datasets
---------
Before running the benchmark all datasets must be downloaded from the remore server. The dataset used by the benchmark is 35GB which is split into four folders: training (28 GB, 148006 files), validation (3.8 GB, 20401 files), testing (1.8 GB, 9374 files) and inference (1.8 GB, 9375 files).


The datasets can be downloaded from remote server by using this command:
aws s3 --no-sign-request --endpoint-url https://s3.echo.stfc.ac.uk sync s3://sciml-datasets/ms/stemdl_ds1 ./

The target directory in this case is the local one "./", but any other directory path with a write permission can also be provided.  As a result of the aws command four directories will be created: training, testing, validation and inference.

 




Installation
-------------
If Anaconda is not installed on the system, it can be downloaded from the distribution site.

Installation
------------
It is recommended to run the Stemdl benchmark in the Anaconda environment.
For the installation use the following instructions:

1) If Anaconda is not already installed on the system, it can be downloaded from
 here:
    wget https://repo.anaconda.com/archive/Anaconda3-2021.05-Linux-x86_64.sh

2)Install Anaconda
    bash Anaconda3-2021.05-Linux-x86_64.sh

3) Create conda environment
      conda create --name bench python=3.8

4) conda activate bench

5) pip install pytorch-lightning

6) pip install torchvision
7) pip install scikit-learn
8) For installing the MLCommons logging library please follow the instructions at https://github.com/mlcommons/logging

9) Running the benchmark
python sytemdl_classification.py --config stemdlConfig.yaml




Measurements
------------
*** Quadro GV100, GPU=1 ***
Stemdl training, samples=138717, resnet=resnet18, epochs=20, bs=32, nodes=1, gpu=1, training_per_epoch=124.18
Stemdl inference, inferences=8438, bs=32, nodes=1, gpu=1, time_per_inference=0.000346

*** Quadro GV100, GPU=2 ***
Stemdl training, samples=138717, resnet=resnet18, epochs=20, bs=32, nodes=1, gpu=2, training_per_epoch=82.35
Stemdl training, samples=138717, resnet=resnet18, epochs=20, bs=32, nodes=1, gpu=2, training_per_epoch=82.46

Stemdl inference, inferences=8438, bs=32, nodes=1, gpu=2, time_per_inference=0.000227
Stemdl inference, inferences=8438, bs=32, nodes=1, gpu=2, time_per_inference=0.000251


Notes
------
1) Print the accuracy/loss for epoch.
2) Use resnet50, resnet101.

